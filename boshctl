#!/bin/bash

set -e

shopt -s expand_aliases

alias bosh='BUNDLE_GEMFILE=/home/tempest-web/tempest/web/vendor/bosh/Gemfile bundle exec bosh'

usage_and_exit() {
  cat <<EOF
BOSH Control starts or stops all your BOSH deployments.

Usage: boshctl <command>
Examples:
  boshctl start
  boshctl stop
EOF
  exit 1
}

is_logged_in() {
  ! $(bosh status | grep -q 'not logged in')
}

get_deployments() {
  bosh deployments 2>/dev/null | grep -o '^| [[:alpha:]]\+-.*' | cut -d \| -f 2 | tr -d ' '
}

stop() {
  local deployment=$1
  local deployment_file="/var/tempest/workspaces/default/deployments/$deployment.yml"
  bosh deployment $deployment_file
  bosh -n -N stop --hard
}

start() {
  local deployment=$1
  local deployment_file="/var/tempest/workspaces/default/deployments/$deployment.yml"
  bosh deployment $deployment_file
  bosh -n -N start
}

# Stop all deployments in reverse order
stop_all() {
  if ! is_logged_in; then
    echo "Please log in first"
    bosh login
  fi
  for deployment in $(get_deployments | awk '{a[i++]=$0} END {for (j=i-1; j>=0;) print a[j--] }'); do
    stop $deployment
  done
}

# Start all deployments in order
start_all() {
  if ! is_logged_in; then
    echo "Please log in first"
    bosh login
  fi
  for deployment in $(get_deployments); do
    start $deployment
  done
}

CMD=$1 ARG=$2

if [ "start" = "$CMD" ]; then
  start_all
  bosh tasks
elif [ "stop" = "$CMD" ]; then
  stop_all
  bosh tasks
else
  usage_and_exit
fi
